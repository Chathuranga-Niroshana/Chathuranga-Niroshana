name: Generate Snake

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0
          persist-credentials: true

      - name: Generate snake animation
        uses: Platane/snk@v3
        with:
          github_user_name: Chathuranga-Niroshana
          github_token: ${{ secrets.GH_PAT }}
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark

      - name: Configure git and remote auth
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Ensure the origin remote uses the PAT so non-interactive pushes succeed
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}

      - name: Commit generated images (if changes)
        run: |
          # Add generated artifacts
          git add dist/*.svg || true

          # Only commit if there are staged changes
          if git diff --cached --quiet; then
            echo "No generated changes to commit."
            exit 0
          fi

          git commit -m "chore: update snake contribution image" --author="github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

      - name: Push changes with safe retry on non-fast-forward
        run: |
          # Ensure we are on main
          git checkout -B main

          # Fetch latest remote main
          git fetch origin main

          # Try to rebase our local commits on top of remote main (safe, keeps history linear)
          if ! git rebase origin/main; then
            echo "Rebase failed or there were conflicts. Aborting rebase and attempting pull --rebase."
            git rebase --abort || true
            git pull --rebase origin main || true
          fi

          # Attempt push. Use --force-with-lease as a last resort to avoid clobbering unknown remote changes.
          if ! git push origin HEAD:main --force-with-lease; then
            echo "Push failed on first attempt. Fetching remote and retrying with --force-with-lease."
            git fetch origin main
            git rebase origin/main || (git rebase --abort || true; git pull --rebase origin main || true)
            git push origin HEAD:main --force-with-lease
          fi
        env:
          # ensure PAT available for remote URL substitution (already injected in remote URL above)
          GH_PAT: ${{ secrets.GH_PAT }}
